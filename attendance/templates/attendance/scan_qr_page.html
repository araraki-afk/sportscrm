{% extends 'attendance/base.html' %}

{% block title %}Сканировать QR{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">{{ section_time.section.name }}</h1>
    <h3 class="text-center">Время: {{ section_time.start_time }} - {{ section_time.end_time }}</h3>

    <div class="text-center my-5">
        <h4>Сканируйте QR-код</h4>
        <p>Нажмите кнопку ниже, чтобы открыть камеру для сканирования.</p>
        <button onclick="startCamera()" class="btn btn-primary">Открыть камеру</button>

        <!-- Контейнер для сканера QR-кода -->
        <div id="reader" style="display: none; width: 100%; max-width: 500px; margin: 20px auto;"></div>
        <p id="scan-result" class="mt-3 text-success"></p>
    </div>
</div>

<!-- Подключаем библиотеку html5-qrcode -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<script>
    // Функция для старта камеры
    function startCamera() {
        // Показываем сканер
        const reader = document.getElementById("reader");
        reader.style.display = "block";

        // Инициализация сканера
        const html5QrCode = new Html5Qrcode("reader");

        // Получение списка камер
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                // Автоматический выбор задней камеры (если доступна)
                const backCamera = devices.find(device =>
                    device.label.toLowerCase().includes("back") || device.label.toLowerCase().includes("rear")
                );

                const cameraId = backCamera ? backCamera.id : devices[0].id;

                // Запуск сканирования
                html5QrCode.start(
                    cameraId,
                    { fps: 10, qrbox: 250 },
                    decodedText => {
                        document.getElementById('scan-result').innerHTML = `Код найден: ${decodedText}`;
                        window.location.href = decodedText; // Перенаправление на URL
                    },
                    error => {
                        console.warn(`Ошибка сканирования: ${error}`);
                    }
                );
            } else {
                alert("Камера не найдена!");
            }
        }).catch(err => {
            console.error(`Ошибка получения камер: ${err}`);
            alert("Не удалось получить доступ к камере.");
        });
    }
</script>
{% endblock %}
